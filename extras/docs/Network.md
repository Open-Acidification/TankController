# Architecture

## Machines

* **traefik** is a virtual machine that acts as the public-facing server for [oap.cs.wallawalla.edu](oap.cs.wallawalla.edu). It acts as a firewall and reverse-proxy, forwarding requests to oap-vm.
* **oap-vm** is a virtual machine in our CS Lab that supports various services for the Open Acidification Project (OAP).
* A **Tank Controller** is an Arduino-based device controller that monitors and manages temperature and pH for a tank (aquarium) used in ocean acidification research. It has a 4x4 keypad for input and a 16x2 LCD display for output. It has a serial port used to flash the program memory and communicate with a computer. It also has an Ethernet connection and can make and respond to HTTP requests (the system does not have adequate resources to support HTTPS).
* A **User Agent (Web Browser)** running on a separate machine that can connect to oap-vm or the tank controller.

## Applications

* The original application, **TankController**, is Arduino program that runs on the Tank Controller. It consists of a trivial "sketch" ([TankController.ino](../../examples/TankController/TankController.ino)), a primary library (TankController), and a number of other device-related libraries (see [libraries.md](libraries.md)).
* The second application, **device_client**, is a Flutter application that mimics the Tank Controller's keypad and LCD. It is a single-page application (SPA) served from http://oap.cs.wallawalla.edu. After the static files are loaded, it presents a GUI in which the user can enter the IP address of a Tank Controller and interact—using the web browser—with the Tank Controller as if the device were physically present. The fact that we use one browser to interact with multiple servers presents a couple complications.
  * First, most browsers prevent "Cross-Origin Resource Sharing (CORS)" unless explicitly enabled. In particular, CORS is designed to prevent a malicious (primary) site from scraping content from a secondary site (say, a bank), and sending it to the user (making the user think it is interacting with the bank when it is actually interacting with the malicious site). A secondary site may, however, authorize a primary site to collect and display its data by adding `Access-Control-Allow-Origin: *` to a response header. The TankController does this, and thus solves the CORS issue.
  * Second, if a page is served with HTTPS (typically indicated by a lock in the address bar), most browsers do not let JavaScript on the page make HTTP requests because this would violate the user's expectation of security in the content. This means that if any data is obtained using HTTP, the entire page must be loaded as HTTP (to adequately communicate "insecure" to the user). As mentioned above, the Tank Controller's Arduino processor does not have adequate resources to handle HTTPS, so the Flutter-generated files served from oap.cs.wallawalla.edu must be served using HTTP before making the HTTP requests to the Tank Controller.
  * While the browser sees the device_client app as HTTP, it is actually served by oap-vm as HTTPS and sent on by traefik as HTTP.
* The third application, **log_file_server**, is a Dart server application that runs on oap-vm and accepts data from a Tank Controller and stores it on disk where it can be served by an Nginx web server on oap-vm. Because the Tank Controller does not support HTTPS (either as client or server), the data upload must be done using HTTP to oap.cs.wallawalla.edu (traefik) where it is converted to HTTPS and forwarded to oap-vm. This application also generates an abridged copy of the data to be used as thumbnails showing summary information for a group of Tank Controllers.
* The fourth application, **log_file_client**, is a Flutter SPA that takes the data saved by log_file_server (from the Tank Controllers), and presents it in a graphical format. Because it does not interact directly with a Tank Controller, it can be served from https://oap.cs.wallawalla.edu. In fact, the distinction between device_client and log_file_client is http vs. https.

## Communication

![Network Architecture Diagram](Network.drawio.svg)

* **A**: traefik communicates with oap-vm on an internal network using HTTPS using a self-signed certificate generated by oap-vm and recognized by traefik.
* **B**: The user requests device_client (http://oap.cs.wallawalla.edu) or log_file_client (https://oap.cs.wallawalla.edu) from traefik which forwards the requests to oap-vm.
* **C**: A Tank Controller can send data to log_file_server (using HTTP) to be saved on oap-vm.
* **D**: Using device_client, a user can interact directly with a live Tank Controller (using HTTP).

## Traefik and Nginx Configuration

Traefik receives several types of requests (on links B and C) that it passes on to oap-vm (on link A). Each is sent to oap-vm using HTTPS, so the request needs to be mapped to something that Nginx on oap-vm can recognize as distinct.

### HTTPS

1. GET https://oap.cs.wallawalla.edu/api/ requests are for recent lines from files saved by the log_file_server app (link B).
    * Traefik forwards to https://oap.vm.cs.wallawalla.edu:443/
    * Nginx forwards to http://localhost:8080 (log_file_server)
1. GET https://oap.cs.wallawalla.edu/logs/ requests are for files saved by the log_file_server app (link B).
    * Traefik forwards to https://oap.vm.cs.wallawalla.edu:443/
    * Nginx serves `/var/www/html` with `autoindex on`
1. GET https://oap.cs.wallawalla.edu/ requests are for the log_file_client app (link B).
    * Traefik forwards to https://oap.vm.cs.wallawalla.edu:443/
    * Nginx serves `/var/www/html/log_file_client/`

### HTTP

1. GET http://oap.cs.wallawalla.edu/ requests are for the device_client app (link B).
    * Traefik forwards to https://oap.vm.cs.wallawalla.edu:444/
    * Nginx serves `/var/www/html/device_client/`
1. HEAD http://oap.cs.wallawalla.edu/logs/ requests are for the size of log files (link C).
    * Traefik forwards to https://oap.vm.cs.wallawalla.edu:444/logs/
    * Nginx serves `/var/www/html/`
1. POST http://oap.cs.wallawalla.edu/api/ requests are to the log_file_server app (link C).
    * Traefik forwards to https://oap.vm.cs.wallawalla.edu:444/api/
    * Nginx forwards to http://localhost:8080 (log_file_server)
